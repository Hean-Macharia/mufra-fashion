{% extends "admin/base.html" %}

{% block title %}Newsletter Management - MUFRA ADMIN{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0"><i class="fas fa-envelope me-2"></i>Newsletter Management</h1>
            <p class="text-muted">Manage newsletter subscriptions and send messages to all subscribers</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stat-card subscribers-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Active Subscribers</h6>
                            <h2 class="mb-0">{{ active_subscriptions }}</h2>
                        </div>
                        <i class="fas fa-envelope fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Total Subscriptions</h6>
                            <h2 class="mb-0">{{ total_subscriptions }}</h2>
                        </div>
                        <i class="fas fa-users fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Newsletters Sent</h6>
                            <h2 class="mb-0">{{ newsletters|length }}</h2>
                        </div>
                        <i class="fas fa-paper-plane fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Newsletter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-pen me-2"></i>Send Newsletter</h5>
                </div>
                <div class="card-body">
                    <form id="newsletterForm">
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="subject" name="subject" 
                                   placeholder="Newsletter subject..." required>
                        </div>
                        <div class="mb-3">
                            <label for="message" class="form-label">Message</label>
                            <textarea class="form-control" id="message" name="message" 
                                      rows="8" placeholder="Write your newsletter message..." required></textarea>
                            <small class="text-muted">HTML formatting is supported</small>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Newsletter will be sent to <strong>{{ active_subscriptions }}</strong> active subscribers
                        </div>
                        <button type="submit" class="btn btn-primary" id="sendBtn">
                            <i class="fas fa-paper-plane me-2"></i>Send Newsletter
                        </button>
                        <span id="sendStatus" style="display: none; margin-left: 10px;">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span id="statusText">Sending...</span>
                        </span>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Newsletters -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Newsletters</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Subject</th>
                                <th>Sent By</th>
                                <th>Date Sent</th>
                                <th>Recipients</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if newsletters %}
                                {% for newsletter in newsletters %}
                                <tr>
                                    <td>
                                        <strong>{{ newsletter.subject }}</strong>
                                    </td>
                                    <td>{{ newsletter.sent_by }}</td>
                                    <td>
                                        <small>{{ newsletter.sent_at.strftime('%b %d, %Y %H:%M') }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ newsletter.recipients_count }}/{{ newsletter.total_subscribers }}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary view-newsletter" 
                                                data-id="{{ newsletter._id }}"
                                                title="View newsletter content">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x opacity-50 d-block mb-2"></i>
                                        No newsletters sent yet
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Newsletter Modal -->
<div class="modal fade" id="viewNewsletterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Newsletter Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="newsLetterContent"></div>
            </div>
        </div>
    </div>
</div>

<style>
    .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border: none;
        border-radius: 12px;
    }
    
    .subscribers-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .subscribers-card .text-muted,
    .subscribers-card h6 {
        color: rgba(255, 255, 255, 0.8) !important;
    }
    
    .form-control,
    .form-label {
        border-radius: 8px;
    }
    
    .form-control:focus {
        border-color: #D81B60;
        box-shadow: 0 0 0 0.2rem rgba(216, 27, 96, 0.25);
    }
    
    #sendStatus {
        color: #28a745;
        font-weight: 500;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(216, 27, 96, 0.05);
    }
</style>

<script>
document.getElementById('newsletterForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const sendBtn = document.getElementById('sendBtn');
    const sendStatus = document.getElementById('sendStatus');
    const statusText = document.getElementById('statusText');
    
    // Show loading state
    sendBtn.disabled = true;
    sendStatus.style.display = 'inline-block';
    
    try {
        const formData = new FormData(document.getElementById('newsletterForm'));
        const response = await fetch('{{ url_for("admin_send_newsletter") }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            statusText.textContent = `âœ“ Sent to ${data.sent_count} subscribers!`;
            document.getElementById('newsletterForm').reset();
            setTimeout(() => {
                sendStatus.style.display = 'none';
                sendBtn.disabled = false;
                location.reload();
            }, 2000);
        } else {
            alert('Error: ' + data.error);
            sendBtn.disabled = false;
            sendStatus.style.display = 'none';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to send newsletter');
        sendBtn.disabled = false;
        sendStatus.style.display = 'none';
    }
});

// View newsletter content
document.querySelectorAll('.view-newsletter').forEach(btn => {
    btn.addEventListener('click', function() {
        const newsletter = {{ newsletters|tojson|safe }};
        // Find matching newsletter
        for (let nl of newsletter) {
            if (nl._id === this.dataset.id) {
                document.getElementById('newsLetterContent').innerHTML = `
                    <div class="mb-3">
                        <label class="text-muted small">Subject</label>
                        <h5>${nl.subject}</h5>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Message</label>
                        <div class="border padding: 12px; border-radius: 8px;">
                            ${nl.message}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Recipients</label>
                        <p>${nl.recipients_count} of ${nl.total_subscribers} subscribers</p>
                    </div>
                `;
                break;
            }
        }
        new bootstrap.Modal(document.getElementById('viewNewsletterModal')).show();
    });
});
</script>
{% endblock %}
