{% extends "base.html" %}

{% block title %}Shopping Cart - MUFRA FASHIONS{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('home') }}" class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
                </ol>
            </nav>
            <h1 class="display-5 fw-bold mb-3">Shopping Cart</h1>
            <p class="text-muted">Review your items and proceed to checkout</p>
        </div>
    </div>
    
    {% if cart_items and cart_items|length > 0 %}
    <div class="row">
        <!-- Cart Items -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <!-- Cart Header - Desktop -->
                    <div class="d-none d-lg-flex bg-light p-3 border-bottom">
                        <div class="col-5 fw-bold">Product</div>
                        <div class="col-2 fw-bold text-center">Price</div>
                        <div class="col-3 fw-bold text-center">Quantity</div>
                        <div class="col-2 fw-bold text-center">Total</div>
                        <div class="col-1"></div>
                    </div>
                    
                    {% for item in cart_items %}
                    <div class="p-3 border-bottom">
                        <div class="row align-items-center">
                            <!-- Product Info -->
                            <div class="col-lg-5 mb-3 mb-lg-0">
                                <div class="d-flex align-items-center">
                                    <div class="me-3" style="width: 80px; height: 80px;">
                                        {% if item.product.images and item.product.images[0] %}
                                            <img src="{{ item.product.images[0] }}" 
                                                 alt="{{ item.product.name }}"
                                                 class="img-fluid rounded"
                                                 style="width: 100%; height: 100%; object-fit: cover;"
                                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/80x80?text=No+Image';">
                                        {% else %}
                                            <img src="https://via.placeholder.com/80x80?text=No+Image" 
                                                 alt="{{ item.product.name }}"
                                                 class="img-fluid rounded">
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h5 class="mb-1">{{ item.product.name }}</h5>
                                        <div class="d-flex gap-2 mt-2">
                                            {% if item.size %}
                                                <span class="badge bg-secondary">{{ item.size }}</span>
                                            {% endif %}
                                            {% if item.color %}
                                                <span class="badge bg-secondary">{{ item.color }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Price -->
                            <div class="col-lg-2 mb-3 mb-lg-0 text-center">
                                <div class="d-lg-none text-muted small mb-1">Price</div>
                                <span class="h5 text-primary">KSh {{ "%.2f"|format(item.product.price) }}</span>
                            </div>
                            
                            <!-- Quantity -->
                            <div class="col-lg-3 mb-3 mb-lg-0">
                                <div class="d-lg-none text-muted small mb-2">Quantity</div>
                                <div class="d-flex align-items-center justify-content-center">
                                    <button class="btn btn-outline-secondary btn-sm"
                                            onclick="updateQuantity('{{ loop.index0 }}', -1)">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" 
                                           class="form-control form-control-sm mx-2 text-center" 
                                           value="{{ item.quantity }}" 
                                           min="1" 
                                           style="max-width: 70px;"
                                           data-index="{{ loop.index0 }}">
                                    <button class="btn btn-outline-secondary btn-sm"
                                            onclick="updateQuantity('{{ loop.index0 }}', 1)">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Total -->
                            <div class="col-lg-2 mb-3 mb-lg-0 text-center">
                                <div class="d-lg-none text-muted small mb-1">Total</div>
                                <span class="h5 text-primary">KSh {{ "%.2f"|format(item.item_total) }}</span>
                            </div>
                            
                            <!-- Remove -->
                            <div class="col-lg-1 text-center">
                                <button class="btn btn-outline-danger btn-sm"
                                        onclick="removeItem('{{ loop.index0 }}')"
                                        title="Remove item">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Continue Shopping -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <a href="{{ url_for('categories') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </a>
                <button class="btn btn-outline-danger" onclick="clearCart()">
                    <i class="bi bi-trash me-2"></i>Clear Cart
                </button>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h4 class="card-title mb-4">Order Summary</h4>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal</span>
                        <span class="fw-bold">KSh {{ "%.2f"|format(total) }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Shipping</span>
                        <span class="text-muted small">Calculated at checkout</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Tax</span>
                        <span class="fw-bold">KSh 0.00</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Discount</span>
                        <span class="text-success">- KSh 0.00</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-4">
                        <span class="h5 fw-bold">Total</span>
                        <span class="h4 text-primary fw-bold">KSh {{ "%.2f"|format(total) }}</span>
                    </div>
                    
                    <a href="{{ url_for('checkout') }}" class="btn btn-primary btn-lg w-100 mb-3">
                        Proceed to Checkout <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                    
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="bi bi-shield-check me-1"></i>
                            Secure checkout
                        </small>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="mb-3">Accepted Payment Methods</h6>
                        <div class="d-flex justify-content-around">
                            <i class="bi bi-wallet2 fs-4 text-success" title="M-Pesa"></i>
                            <i class="bi bi-credit-card fs-4 text-primary" title="Visa"></i>
                            <i class="bi bi-credit-card-2-front fs-4 text-danger" title="Mastercard"></i>
                            <i class="bi bi-phone fs-4 text-warning" title="Airtel Money"></i>
                            <i class="bi bi-cash fs-4 text-success" title="Cash on Delivery"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Promo Code -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Have a Promo Code?</h5>
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Enter promo code">
                        <button class="btn btn-outline-primary" type="button">Apply</button>
                    </div>
                </div>
            </div>
            
            <!-- Security Badges -->
            <div class="mt-4 text-center">
                <div class="row g-2">
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <i class="bi bi-truck fs-4 text-primary"></i>
                            <div class="small mt-1">Free Shipping*</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <i class="bi bi-arrow-counterclockwise fs-4 text-primary"></i>
                            <div class="small mt-1">30-Day Returns</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <i class="bi bi-shield-check fs-4 text-primary"></i>
                            <div class="small mt-1">Secure Payment</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Empty Cart -->
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6 text-center">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-5">
                    <div class="mb-4">
                        <i class="bi bi-cart-x display-1 text-muted"></i>
                    </div>
                    <h2 class="h3 mb-3">Your Cart is Empty</h2>
                    <p class="text-muted mb-4">
                        Looks like you haven't added any items to your cart yet. 
                        Start shopping to add items to your cart.
                    </p>
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <a href="{{ url_for('categories') }}" class="btn btn-primary btn-lg px-4">
                            <i class="bi bi-bag me-2"></i>Start Shopping
                        </a>
                        <a href="{{ url_for('categories') }}?subcategory=new" class="btn btn-outline-primary btn-lg px-4">
                            <i class="bi bi-star me-2"></i>New Arrivals
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Recommended Products -->
            <div class="mt-5">
                <h3 class="h4 mb-4">You Might Also Like</h3>
                <div class="row g-3">
                    <!-- Product 1 -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-bag display-6 text-muted"></i>
                                </div>
                                <h6 class="card-title">Trendy Sneakers</h6>
                                <p class="text-primary fw-bold mb-0">KSh 2,500</p>
                            </div>
                        </div>
                    </div>
                    <!-- Product 2 -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-bag display-6 text-muted"></i>
                                </div>
                                <h6 class="card-title">Designer Shirts</h6>
                                <p class="text-primary fw-bold mb-0">KSh 1,800</p>
                            </div>
                        </div>
                    </div>
                    <!-- Product 3 -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-bag display-6 text-muted"></i>
                                </div>
                                <h6 class="card-title">Casual Jeans</h6>
                                <p class="text-primary fw-bold mb-0">KSh 2,200</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Cart Functions
function updateQuantity(index, change) {
    const quantityInput = document.querySelectorAll('.quantity-input')[index];
    let quantity = parseInt(quantityInput.value) + change;
    
    if (quantity < 1) quantity = 1;
    quantityInput.value = quantity;
    
    // Send update to server
    fetch('/update_cart_item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            index: index,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Quantity updated successfully', 'success');
            // Update cart count and totals
            updateCartUI(data);
        } else {
            showToast('Error updating quantity', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating quantity', 'danger');
    });
}

function removeItem(index) {
    if (confirm('Are you sure you want to remove this item from your cart?')) {
        fetch('/remove_cart_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ index: index })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Item removed from cart', 'success');
                // Reload page to update cart
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast('Error removing item', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error removing item', 'danger');
        });
    }
}

function clearCart() {
    if (confirm('Are you sure you want to clear your entire cart?')) {
        fetch('/clear_cart', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Cart cleared successfully', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast('Error clearing cart', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error clearing cart', 'danger');
        });
    }
}

function updateCartUI(data) {
    // Update cart count in header
    document.querySelectorAll('#cartCount, #floatingCartCount').forEach(el => {
        el.textContent = data.cart_count;
    });
    
    // If on cart page, update totals
    if (document.querySelector('.cart-total')) {
        document.querySelector('.cart-total').textContent = `KSh ${data.total.toFixed(2)}`;
    }
}

// Add input event listeners for direct quantity input
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            const index = this.dataset.index;
            const quantity = parseInt(this.value);
            
            if (quantity < 1) {
                this.value = 1;
                return;
            }
            
            fetch('/update_cart_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    index: index,
                    quantity: quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Quantity updated', 'success');
                    updateCartUI(data);
                }
            });
        });
    });
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Toast notification using Bootstrap
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.role = 'alert';
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 
                               type === 'danger' ? 'bi-exclamation-circle-fill' : 
                               'bi-info-circle-fill'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
        delay: 3000,
        autohide: true
    });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>

<style>
/* Custom Cart Styles */
.card {
    border-radius: 15px;
}

.quantity-input {
    -moz-appearance: textfield;
}

.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.sticky-top {
    position: -webkit-sticky;
    position: sticky;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .quantity-input {
        max-width: 60px !important;
    }
    
    .display-5 {
        font-size: 2rem;
    }
}

/* Hover effects */
.btn-outline-danger:hover {
    background-color: var(--bs-danger);
    color: white;
}

.btn-outline-primary:hover {
    background-color: var(--bs-primary);
    color: white;
}

/* Animation for cart updates */
@keyframes highlight {
    0% { background-color: rgba(108, 99, 255, 0.1); }
    100% { background-color: transparent; }
}

.highlight-update {
    animation: highlight 1s ease-in-out;
}
</style>
{% endblock %}