{% extends "base.html" %}

{% block title %}Browse Categories - MUFRA FASHIONS{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3 fw-bold text-charcoal">Browse Our Collection</h1>
            <p class="text-grey-medium lead">Discover trendy shoes and clothes for every occasion</p>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm border-0 bg-white">
                <div class="card-header bg-magenta text-white border-0 rounded-top py-3">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-filter me-2"></i>Filters</h5>
                </div>
                <div class="card-body bg-white">
                    <form method="GET" action="{{ url_for('categories') }}" id="filterForm">
                        <!-- Category Filter -->
                        <div class="mb-4">
                            <h6 class="mb-3 fw-bold text-charcoal"><i class="fas fa-tags me-2 text-magenta"></i>Category</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="category" 
                                       id="categoryAll" value="" {% if not selected_category %}checked{% endif %}>
                                <label class="form-check-label text-charcoal" for="categoryAll">
                                    All Categories
                                </label>
                            </div>
                            {% for cat in categories %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="category" 
                                       id="category{{ cat.name }}" value="{{ cat.name }}"
                                       {% if selected_category == cat.name %}checked{% endif %}>
                                <label class="form-check-label d-flex align-items-center text-charcoal" for="category{{ cat.name }}">
                                    {% if cat.name|lower == 'shoes' %}
                                        <i class="fas fa-shoe-prints me-2 text-cyan"></i>
                                    {% elif cat.name|lower == 'clothes' %}
                                        <i class="fas fa-tshirt me-2 text-cyan"></i>
                                    {% else %}
                                        <i class="fas fa-tag me-2 text-cyan"></i>
                                    {% endif %}
                                    {{ cat.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Condition Filter -->
                        <div class="mb-4">
                            <h6 class="mb-3 fw-bold text-charcoal"><i class="fas fa-certificate me-2 text-magenta"></i>Condition</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="condition" 
                                       id="conditionAll" value="" {% if not selected_condition %}checked{% endif %}>
                                <label class="form-check-label text-charcoal" for="conditionAll">
                                    All Conditions
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="condition" 
                                       id="conditionNew" value="New"
                                       {% if selected_condition == 'New' %}checked{% endif %}>
                                <label class="form-check-label text-cyan" for="conditionNew">
                                    <i class="fas fa-star me-1 text-cyan"></i> New
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="condition" 
                                       id="conditionUsed" value="Second Hand"
                                       {% if selected_condition == 'Second Hand' %}checked{% endif %}>
                                <label class="form-check-label text-grey-medium" for="conditionUsed">
                                    <i class="fas fa-recycle me-1 text-cyan"></i> Pre-Owned
                                </label>
                            </div>
                        </div>

                        <!-- Price Range -->
                        <div class="mb-4">
                            <h6 class="mb-3 fw-bold text-charcoal"><i class="fas fa-money-bill-wave me-2 text-magenta"></i>Price Range (KES)</h6>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm border-grey-medium" 
                                           name="min_price" placeholder="Min" min="0" 
                                           value="{{ request.args.get('min_price', '') }}">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm border-grey-medium" 
                                           name="max_price" placeholder="Max" min="0"
                                           value="{{ request.args.get('max_price', '') }}">
                                </div>
                            </div>
                            <div class="range-slider">
                                <input type="range" class="form-range" min="0" max="100000" 
                                       step="100" id="priceRange" value="0">
                            </div>
                        </div>

                        <!-- Availability Filter -->
                        <div class="mb-4">
                            <h6 class="mb-3 fw-bold text-charcoal"><i class="fas fa-box me-2 text-magenta"></i>Availability</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="inStockOnly" 
                                       name="in_stock" {% if request.args.get('in_stock') %}checked{% endif %}>
                                <label class="form-check-label text-charcoal" for="inStockOnly">
                                    Show in-stock only
                                </label>
                            </div>
                        </div>

                        <!-- Featured Filter -->
                        <div class="mb-4">
                            <h6 class="mb-3 fw-bold text-charcoal"><i class="fas fa-star me-2 text-magenta"></i>Featured</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="featuredOnly" 
                                       name="featured" {% if request.args.get('featured') %}checked{% endif %}>
                                <label class="form-check-label text-charcoal" for="featuredOnly">
                                    Featured products only
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-magenta text-white py-2" id="applyFilters">
                                <i class="fas fa-search me-2"></i> Apply Filters
                            </button>
                            {% if selected_category or selected_condition or request.args.get('min_price') or request.args.get('max_price') or request.args.get('in_stock') or request.args.get('featured') %}
                            <a href="{{ url_for('categories') }}" class="btn btn-outline-grey-medium text-charcoal border-grey-medium">
                                <i class="fas fa-redo me-2"></i> Clear All Filters
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card shadow-sm border-0 mt-4 bg-white">
                <div class="card-body">
                    <h6 class="card-title mb-3 fw-bold text-charcoal"><i class="fas fa-chart-bar me-2 text-magenta"></i>Quick Stats</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-grey-medium">Total Products:</span>
                        <span class="fw-bold text-magenta">{{ products|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-grey-medium">Shoes:</span>
                        <span class="fw-bold">
                            {% set shoes_count = products|selectattr('category', 'equalto', 'Shoes')|list|length %}
                            <span class="badge bg-cyan text-white">{{ shoes_count }}</span>
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-grey-medium">Clothes:</span>
                        <span class="fw-bold">
                            {% set clothes_count = products|selectattr('category', 'equalto', 'Clothes')|list|length %}
                            <span class="badge bg-cyan text-white">{{ clothes_count }}</span>
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-grey-medium">New Items:</span>
                        <span class="fw-bold">
                            {% set new_count = products|selectattr('condition', 'equalto', 'New')|list|length %}
                            <span class="badge bg-magenta text-white">{{ new_count }}</span>
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-grey-medium">Featured:</span>
                        <span class="fw-bold">
                            {% set featured_count = products|selectattr('featured', 'equalto', True)|list|length %}
                            <span class="badge bg-cyan text-white">{{ featured_count }}</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Categories Quick Links -->
            <div class="card shadow-sm border-0 mt-4 bg-white">
                <div class="card-body">
                    <h6 class="card-title mb-3 fw-bold text-charcoal"><i class="fas fa-th-list me-2 text-magenta"></i>Categories</h6>
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('categories') }}?category=Shoes" 
                           class="list-group-item list-group-item-action d-flex align-items-center {% if selected_category == 'Shoes' %}active bg-cyan text-white{% endif %} bg-white text-charcoal border-0">
                            <i class="fas fa-shoe-prints me-3 {% if selected_category == 'Shoes' %}text-white{% else %}text-cyan{% endif %}"></i>
                            Shoes
                            <span class="badge {% if selected_category == 'Shoes' %}bg-white text-cyan{% else %}bg-cyan text-white{% endif %} ms-auto">
                                {{ products|selectattr('category', 'equalto', 'Shoes')|list|length }}
                            </span>
                        </a>
                        <a href="{{ url_for('categories') }}?category=Clothes" 
                           class="list-group-item list-group-item-action d-flex align-items-center {% if selected_category == 'Clothes' %}active bg-cyan text-white{% endif %} bg-white text-charcoal border-0">
                            <i class="fas fa-tshirt me-3 {% if selected_category == 'Clothes' %}text-white{% else %}text-cyan{% endif %}"></i>
                            Clothes
                            <span class="badge {% if selected_category == 'Clothes' %}bg-white text-cyan{% else %}bg-cyan text-white{% endif %} ms-auto">
                                {{ products|selectattr('category', 'equalto', 'Clothes')|list|length }}
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Products Grid -->
        <div class="col-lg-9">
            <!-- Category Cards -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <a href="{{ url_for('categories') }}?category=Shoes" class="text-decoration-none">
                        <div class="card border-0 shadow-sm bg-gradient-cyan h-100">
                            <div class="card-body text-center text-white p-4">
                                <div class="category-icon mb-3">
                                    <i class="fas fa-shoe-prints fa-3x"></i>
                                </div>
                                <h5 class="card-title fw-bold">Shoes</h5>
                                <p class="card-text opacity-90">Sports, Casual, Formal footwear</p>
                                <span class="badge bg-white text-cyan px-3 py-2">
                                    {% set shoes_count = products|selectattr('category', 'equalto', 'Shoes')|list|length %}
                                    {{ shoes_count }} items
                                </span>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-6 mb-3">
                    <a href="{{ url_for('categories') }}?category=Clothes" class="text-decoration-none">
                        <div class="card border-0 shadow-sm bg-gradient-cyan h-100">
                            <div class="card-body text-center text-white p-4">
                                <div class="category-icon mb-3">
                                    <i class="fas fa-tshirt fa-3x"></i>
                                </div>
                                <h5 class="card-title fw-bold">Clothes</h5>
                                <p class="card-text opacity-90">Tops, Bottoms, and more</p>
                                <span class="badge bg-white text-cyan px-3 py-2">
                                    {% set clothes_count = products|selectattr('category', 'equalto', 'Clothes')|list|length %}
                                    {{ clothes_count }} items
                                </span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Products Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="mb-0 fw-bold text-charcoal">
                        {% if selected_category %}
                            <i class="fas fa-{{ 'shoe-prints' if selected_category == 'Shoes' else 'tshirt' }} me-2 text-cyan"></i>
                            <span class="text-charcoal">{{ selected_category }}</span>
                            {% if selected_condition %}
                                <span class="text-grey-medium">- {{ selected_condition }}</span>
                            {% endif %}
                        {% else %}
                            <i class="fas fa-boxes me-2 text-cyan"></i>
                            <span class="text-charcoal">All Products</span>
                        {% endif %}
                    </h3>
                    <p class="text-grey-medium mb-0">{{ products|length }} products found</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-magenta dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="fas fa-sort me-2"></i>Sort By
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item text-charcoal" href="#" data-sort="latest"><i class="fas fa-clock me-2 text-cyan"></i>Latest</a></li>
                            <li><a class="dropdown-item text-charcoal" href="#" data-sort="price_low"><i class="fas fa-arrow-up me-2 text-cyan"></i>Price: Low to High</a></li>
                            <li><a class="dropdown-item text-charcoal" href="#" data-sort="price_high"><i class="fas fa-arrow-down me-2 text-cyan"></i>Price: High to Low</a></li>
                            <li><a class="dropdown-item text-charcoal" href="#" data-sort="rating"><i class="fas fa-star me-2 text-cyan"></i>Highest Rated</a></li>
                            <li><a class="dropdown-item text-charcoal" href="#" data-sort="popular"><i class="fas fa-fire me-2 text-cyan"></i>Most Popular</a></li>
                            <li><a class="dropdown-item text-charcoal" href="#" data-sort="name"><i class="fas fa-sort-alpha-down me-2 text-cyan"></i>Name: A-Z</a></li>
                        </ul>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-grey-medium active" data-view="grid">
                            <i class="fas fa-th"></i>
                        </button>
                        <button type="button" class="btn btn-outline-grey-medium" data-view="list">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            {% if products %}
            <!-- Products Grid -->
            <div class="row" id="productsGrid">
                {% for product in products %}
                {% set product_id = safe_get(product, '_id', '')|string %}
                <div class="col-xl-4 col-lg-4 col-md-6 mb-4 product-card">
                    <div class="card h-100 product-card-inner bg-white border-0">
                        <div class="position-relative">
                            <a href="{{ url_for('product_details', product_id=product_id) if product_id else '#' }}" class="product-link">
                                {% set product_images = get_product_images(product) %}
                                {% if product_images|length > 1 %}
                                <div class="position-relative product-image-container">
                                    <!-- First image -->
                                    <img src="{{ product_images[0].url }}" 
                                         class="card-img-top product-image product-image-main" 
                                         alt="{{ product.name }}"
                                         onerror="this.src='https://via.placeholder.com/400x300?text=Product'">
                                    <!-- Second image on hover -->
                                    <img src="{{ product_images[1].url }}" 
                                         class="card-img-top product-image product-image-hover" 
                                         alt="{{ product.name }}"
                                         onerror="this.src='https://via.placeholder.com/400x300?text=Product'">
                                    
                                    <!-- Image count badge -->
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-charcoal bg-opacity-85">
                                            <i class="fas fa-images me-1"></i>{{ product_images|length }}
                                        </span>
                                    </div>
                                </div>
                                {% else %}
                                <img src="{{ get_main_product_image(product) }}" 
                                     class="card-img-top product-image" 
                                     alt="{{ product.name }}"
                                     onerror="this.src='https://via.placeholder.com/400x300?text=Product'">
                                {% endif %}
                            </a>
                            
                            <!-- Wishlist Button -->
                            <button class="btn btn-light btn-sm position-absolute top-0 start-0 m-2 wishlist-btn rounded-circle" 
                                    data-product-id="{{ product_id }}"
                                    title="Add to wishlist">
                                <i class="far fa-heart text-magenta"></i>
                            </button>
                            
                            <!-- Condition Badge -->
                            {% set condition = safe_get(product, 'condition', '') %}
                            {% if condition %}
                            <span class="badge {% if condition == 'New' %}bg-cyan{% else %}bg-grey-medium{% endif %} text-white position-absolute bottom-0 start-0 m-2">
                                {{ condition }}
                            </span>
                            {% endif %}
                            
                            <!-- Discount Badge -->
                            {% set discount = safe_get(product, 'discount', 0) %}
                            {% if discount and discount > 0 %}
                            <span class="badge bg-magenta position-absolute top-0 end-0 m-2">
                                <i class="fas fa-tag me-1"></i>{{ discount }}% OFF
                            </span>
                            {% endif %}
                            
                            <!-- Featured Badge -->
                            {% if safe_get(product, 'featured', False) %}
                            <span class="badge bg-cyan position-absolute top-0 start-0 m-2">
                                <i class="fas fa-star me-1"></i>Featured
                            </span>
                            {% endif %}
                            
                            <!-- Out of Stock Overlay -->
                            {% set stock = safe_get(product, 'stock', 0)|int %}
                            {% if stock == 0 %}
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-charcoal bg-opacity-75 d-flex align-items-center justify-content-center">
                                <span class="badge bg-magenta px-3 py-2">
                                    <i class="fas fa-ban me-2"></i>Out of Stock
                                </span>
                            </div>
                            {% endif %}
                            
                            <!-- Quick View Button -->
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <button class="btn btn-magenta btn-sm rounded-circle quick-view-btn" 
                                        data-product-id="{{ product_id }}"
                                        title="Quick View">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">
                                    <a href="{{ url_for('product_details', product_id=product_id) if product_id else '#' }}" 
                                       class="text-decoration-none text-cyan fw-bold product-title">
                                        {{ truncate_text(safe_get(product, 'name', 'Unnamed Product'), 40) }}
                                    </a>
                                </h5>
                                <span class="badge bg-soft-cyan text-cyan border">
                                    {{ safe_get(product, 'category', 'Uncategorized') }}
                                </span>
                            </div>
                            <p class="card-text text-grey-medium small mb-2">
                                {{ truncate_text(safe_get(product, 'description', ''), 70) }}
                            </p>
                            
                            <div class="rating mb-2">
                                {% set product_rating = safe_get(product, 'rating', 0) %}
                                {% set product_reviews = safe_get(product, 'reviews_count', 0) %}
                                
                                {% for i in range(5) %}
                                    {% if i < product_rating|int %}
                                        <i class="fas fa-star text-cyan"></i>
                                    {% elif i < product_rating %}
                                        <i class="fas fa-star-half-alt text-cyan"></i>
                                    {% else %}
                                        <i class="far fa-star text-cyan"></i>
                                    {% endif %}
                                {% endfor %}
                                <small class="text-grey-medium ms-2">({{ product_reviews }})</small>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {% set price = safe_get(product, 'price', 0) %}
                                    {% if discount and discount > 0 %}
                                        {% set discounted_price = price * (1 - discount/100) %}
                                        <h4 class="price mb-0 text-magenta fw-bold">{{ format_price(discounted_price) }}</h4>
                                        <small class="text-grey-medium text-decoration-line-through">{{ format_price(price) }}</small>
                                    {% else %}
                                        <h4 class="price mb-0 text-magenta fw-bold">{{ format_price(price) }}</h4>
                                    {% endif %}
                                    <small class="text-grey-medium d-block">
                                        {% if stock > 10 %}
                                            <span class="text-cyan">
                                                <i class="fas fa-check-circle me-1"></i>In Stock
                                            </span>
                                        {% elif stock > 0 %}
                                            <span class="text-grey-medium">
                                                <i class="fas fa-exclamation-circle me-1"></i>Only {{ stock }} left
                                            </span>
                                        {% else %}
                                            <span class="text-magenta">
                                                <i class="fas fa-times-circle me-1"></i>Out of Stock
                                            </span>
                                        {% endif %}
                                    </small>
                                </div>
                                {% if stock > 0 and product_id %}
                                <form class="add-to-cart-form m-0" data-product-id="{{ product_id }}">
                                    <input type="hidden" name="size" value="{{ safe_get(product, 'sizes', ['M'])[0] }}">
                                    <input type="hidden" name="color" value="{{ safe_get(product, 'colors', ['Blue'])[0] }}">
                                    <input type="hidden" name="quantity" value="1">
                                    <button type="submit" class="btn btn-magenta rounded-circle p-0 d-flex align-items-center justify-content-center" 
                                            style="width: 44px; height: 44px;" title="Add to Cart">
                                        <i class="fas fa-cart-plus"></i>
                                    </button>
                                </form>
                                {% elif not product_id %}
                                <button class="btn btn-outline-grey-medium rounded-circle p-0" disabled style="width:44px;height:44px;">
                                    <i class="fas fa-ban"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-charcoal rounded-circle p-0" disabled style="width:44px;height:44px;">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-footer bg-white border-top-0 pt-0 pb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-grey-medium">
                                    {% set sizes = safe_get(product, 'sizes', []) %}
                                    {% if sizes %}
                                    <i class="fas fa-ruler me-1 text-cyan"></i>
                                    {% for size in sizes[:2] %}
                                        <span class="badge bg-soft-cyan text-cyan border me-1">{{ size }}</span>
                                    {% endfor %}
                                    {% if sizes|length > 2 %}
                                    <span class="badge bg-soft-cyan text-cyan border">+{{ sizes|length - 2 }}</span>
                                    {% endif %}
                                    {% endif %}
                                </small>
                                <small class="text-grey-medium">
                                    {% set colors = safe_get(product, 'colors', []) %}
                                    {% if colors %}
                                    <i class="fas fa-palette me-1 text-magenta"></i>
                                    {% for color in colors[:2] %}
                                        <span class="color-dot me-1" style="background-color: {{ color|lower }};" title="{{ color }}"></span>
                                    {% endfor %}
                                    {% if colors|length > 2 %}
                                    <span class="badge bg-soft-magenta text-magenta border">+{{ colors|length - 2 }}</span>
                                    {% endif %}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Products List View (Hidden by default) -->
            <div class="row d-none" id="productsList">
                {% for product in products %}
                {% set product_id = safe_get(product, '_id', '')|string %}
                <div class="col-12 mb-3 product-card-list">
                    <div class="card bg-white border-0">
                        <div class="row g-0">
                            <div class="col-md-3">
                                {% set product_images = get_product_images(product) %}
                                <img src="{{ get_main_product_image(product) }}" 
                                     class="img-fluid rounded-start h-100 product-image-list" 
                                     alt="{{ product.name }}"
                                     style="object-fit: cover;"
                                     onerror="this.src='https://via.placeholder.com/300x200?text=Product'">
                            </div>
                            <div class="col-md-9">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title">
                                                <a href="{{ url_for('product_details', product_id=product_id) if product_id else '#' }}" 
                                                   class="text-decoration-none text-cyan fw-bold">
                                                    {{ safe_get(product, 'name', 'Unnamed Product') }}
                                                </a>
                                            </h5>
                                            <div class="mb-2">
                                                <span class="badge bg-soft-cyan text-cyan border me-2">
                                                    {{ safe_get(product, 'category', 'Uncategorized') }}
                                                </span>
                                                <span class="badge {% if safe_get(product, 'condition', '') == 'New' %}bg-cyan{% else %}bg-grey-medium{% endif %} text-white">
                                                    {{ safe_get(product, 'condition', 'N/A') }}
                                                </span>
                                                {% if safe_get(product, 'featured', False) %}
                                                <span class="badge bg-cyan">
                                                    <i class="fas fa-star me-1"></i>Featured
                                                </span>
                                                {% endif %}
                                            </div>
                                            <p class="card-text text-grey-medium mb-2">
                                                {{ safe_get(product, 'description', '') }}
                                            </p>
                                            <div class="rating mb-2">
                                                {% set product_rating = safe_get(product, 'rating', 0) %}
                                                {% for i in range(5) %}
                                                    {% if i < product_rating|int %}
                                                        <i class="fas fa-star text-cyan"></i>
                                                    {% else %}
                                                        <i class="far fa-star text-cyan"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <small class="text-grey-medium ms-2">({{ safe_get(product, 'reviews_count', 0) }})</small>
                                            </div>
                                            <div class="d-flex align-items-center gap-3">
                                                <div>
                                                    {% set price = safe_get(product, 'price', 0) %}
                                                    {% set discount = safe_get(product, 'discount', 0) %}
                                                    {% if discount and discount > 0 %}
                                                        {% set discounted_price = price * (1 - discount/100) %}
                                                        <h4 class="price mb-0 text-magenta fw-bold">{{ format_price(discounted_price) }}</h4>
                                                        <small class="text-grey-medium text-decoration-line-through">{{ format_price(price) }}</small>
                                                    {% else %}
                                                        <h4 class="price mb-0 text-magenta fw-bold">{{ format_price(price) }}</h4>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    {% set stock = safe_get(product, 'stock', 0)|int %}
                                                    {% if stock > 0 %}
                                                    <span class="badge bg-cyan">
                                                        <i class="fas fa-check me-1"></i>In Stock
                                                    </span>
                                                    {% else %}
                                                    <span class="badge bg-magenta">
                                                        <i class="fas fa-times me-1"></i>Out of Stock
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column gap-2 ms-3">
                                            {% if stock > 0 and product_id %}
                                            <form class="add-to-cart-form m-0" data-product-id="{{ product_id }}">
                                                <input type="hidden" name="size" value="{{ safe_get(product, 'sizes', ['M'])[0] }}">
                                                <input type="hidden" name="color" value="{{ safe_get(product, 'colors', ['Blue'])[0] }}">
                                                <input type="hidden" name="quantity" value="1">
                                                <button type="submit" class="btn btn-magenta text-white" title="Add to Cart">
                                                    <i class="fas fa-cart-plus me-1"></i> Add to Cart
                                                </button>
                                            </form>
                                            {% endif %}
                                            <a href="{{ url_for('product_details', product_id=product_id) if product_id else '#' }}" 
                                               class="btn btn-outline-cyan">
                                                <i class="fas fa-eye me-1"></i> View Details
                                            </a>
                                            <button class="btn btn-outline-magenta wishlist-btn" 
                                                    data-product-id="{{ product_id }}">
                                                <i class="far fa-heart me-1"></i> Wishlist
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if products|length > 12 %}
            <!-- Load More Button -->
            <div class="text-center mt-5">
                <button class="btn btn-magenta px-5 py-2" id="loadMore">
                    <i class="fas fa-plus me-2"></i> Load More Products
                    <span class="badge bg-white text-magenta ms-2">{{ products|length - 12 }}</span>
                </button>
            </div>
            {% endif %}

            {% else %}
            <!-- No Products Found -->
            <div class="text-center py-5 my-5 bg-white rounded-4">
                <div class="empty-state-icon mb-4">
                    <i class="fas fa-search fa-4x text-grey-medium"></i>
                </div>
                <h3 class="mb-3 text-charcoal">No products found</h3>
                <p class="text-grey-medium mb-4">
                    {% if selected_category or selected_condition or request.args.get('min_price') or request.args.get('max_price') %}
                        No products match your current filters. Try adjusting your selection.
                    {% else %}
                        No products available at the moment. Please check back later.
                    {% endif %}
                </p>
                <div class="d-grid gap-2 d-md-flex justify-content-center">
                    <a href="{{ url_for('categories') }}" class="btn btn-magenta text-white">
                        <i class="fas fa-redo me-2"></i> Clear All Filters
                    </a>
                    <a href="{{ url_for('home') }}" class="btn btn-outline-magenta">
                        <i class="fas fa-home me-2"></i> Back to Home
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Benefits Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-white">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-4 mb-md-0">
                            <div class="benefit-icon mb-3 bg-soft-cyan">
                                <i class="fas fa-shipping-fast fa-2x text-cyan"></i>
                            </div>
                            <h5 class="fw-bold text-charcoal">Fast Delivery</h5>
                            <p class="text-grey-medium small mb-0">Free delivery within Embu for orders over KES 5,000</p>
                        </div>
                        <div class="col-md-3 mb-4 mb-md-0">
                            <div class="benefit-icon mb-3 bg-soft-magenta">
                                <i class="fas fa-shield-alt fa-2x text-magenta"></i>
                            </div>
                            <h5 class="fw-bold text-charcoal">Secure Shopping</h5>
                            <p class="text-grey-medium small mb-0">100% secure payment with Paystack integration</p>
                        </div>
                        <div class="col-md-3 mb-4 mb-md-0">
                            <div class="benefit-icon mb-3 bg-soft-cyan">
                                <i class="fas fa-undo fa-2x text-cyan"></i>
                            </div>
                            <h5 class="fw-bold text-charcoal">Easy Returns</h5>
                            <p class="text-grey-medium small mb-0">30-day return policy for all products</p>
                        </div>
                        <div class="col-md-3">
                            <div class="benefit-icon mb-3 bg-soft-magenta">
                                <i class="fas fa-headset fa-2x text-magenta"></i>
                            </div>
                            <h5 class="fw-bold text-charcoal">24/7 Support</h5>
                            <p class="text-grey-medium small mb-0">Customer support available round the clock</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* ===== MUFRA FASHIONS BRAND COLORS ===== */
    :root {
        --magenta-vibrant: #D81B60;
        --cyan-bright: #00ACC1;
        --link-blue: #2196F3;
        --charcoal-dark: #333333;
        --grey-medium: #757575;
        --bg-light-page: #F9F9F9;
        --white-pure: #FFFFFF;
        --footer-soft-grey: #EEEEEE;
    }

    /* Category Badge */
    .category-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }

    /* Category Icon */
    .category-icon {
        width: 80px;
        height: 80px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }

    /* Card Styles */
    .card {
        transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        border: 1px solid rgba(0,0,0,0.02);
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 36px -12px rgba(216,27,96,0.12);
        border-color: var(--magenta-vibrant);
    }

    .card:hover .product-image-hover {
        opacity: 1;
    }

    /* Form Check Inputs */
    .form-check-input:checked {
        background-color: var(--magenta-vibrant);
        border-color: var(--magenta-vibrant);
    }

    .form-check-input:focus {
        border-color: var(--magenta-vibrant);
        box-shadow: 0 0 0 0.25rem rgba(216,27,96,0.25);
    }

    /* Product Images */
    .product-image {
        height: 250px;
        width: 100%;
        object-fit: cover;
        transition: opacity 0.3s ease, transform 0.6s ease;
    }

    .product-image-main {
        position: relative;
        z-index: 1;
    }

    .product-image-hover {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        z-index: 2;
        transition: opacity 0.4s ease, transform 0.6s ease;
        transform: scale(1.1);
    }

    .product-card:hover .product-image-hover {
        opacity: 1;
        transform: scale(1);
    }

    .product-card:hover .product-image-main {
        opacity: 0;
        transform: scale(0.92);
    }

    .product-image-container {
        height: 250px;
        overflow: hidden;
        border-radius: 16px 16px 0 0;
    }

    .product-image-list {
        height: 200px;
    }

    /* Price */
    .price {
        color: var(--magenta-vibrant);
    }

    /* Rating */
    .rating {
        color: var(--cyan-bright);
    }

    /* Gradient Backgrounds */
    .bg-gradient-cyan {
        background: linear-gradient(135deg, var(--cyan-bright) 0%, #008B9F 100%);
    }

    .bg-gradient-magenta {
        background: linear-gradient(135deg, var(--magenta-vibrant) 0%, #B21550 100%);
    }

    /* Loading Animation */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    /* Toast Notification */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        min-width: 300px;
        border-radius: 12px;
        overflow: hidden;
        border-left: 6px solid;
    }

    .toast-header.bg-success {
        background-color: var(--magenta-vibrant) !important;
    }

    .toast-header.bg-danger {
        background-color: var(--cyan-bright) !important;
    }

    .toast-header.bg-info {
        background-color: var(--link-blue) !important;
    }

    /* Color Dots */
    .color-dot {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid var(--white-pure);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        vertical-align: middle;
    }

    /* Wishlist Button */
    .wishlist-btn {
        transition: all 0.2s ease;
    }

    .wishlist-btn.active {
        color: var(--magenta-vibrant);
    }

    .wishlist-btn.active i {
        font-weight: 900;
    }

    .wishlist-btn:hover {
        transform: scale(1.05);
    }

    /* Quick View Button */
    .quick-view-btn {
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        width: 44px;
        height: 44px;
    }

    .card:hover .quick-view-btn {
        opacity: 1;
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .quick-view-btn {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* View Toggle Buttons */
    .btn-group .btn.active {
        background-color: var(--magenta-vibrant);
        color: white;
        border-color: var(--magenta-vibrant);
    }

    .btn-group .btn.active i {
        color: white;
    }

    /* Benefit Icons */
    .benefit-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        transition: all 0.3s ease;
    }

    .benefit-icon:hover {
        transform: scale(1.1);
    }

    /* Empty State */
    .empty-state-icon {
        width: 120px;
        height: 120px;
        background-color: var(--bg-light-page);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }

    /* Product Title Hover */
    .product-title:hover {
        color: var(--magenta-vibrant) !important;
    }

    /* Add to Cart Button */
    .add-to-cart-form button {
        transition: all 0.2s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .add-to-cart-form button:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 16px rgba(216,27,96,0.3);
    }

    .add-to-cart-form button:active {
        transform: scale(0.95);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .product-image,
        .product-image-container {
            height: 200px;
        }
        
        .product-image-list {
            height: 150px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .quick-view-btn {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Touch Device Improvements */
    @media (hover: none) and (pointer: coarse) {
        .product-image-hover {
            display: none;
        }
        
        .card:hover {
            transform: none;
        }
        
        .quick-view-btn {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Custom Scrollbar */
    #productsGrid::-webkit-scrollbar {
        width: 8px;
    }

    #productsGrid::-webkit-scrollbar-track {
        background: var(--bg-light-page);
        border-radius: 4px;
    }

    #productsGrid::-webkit-scrollbar-thumb {
        background: var(--grey-medium);
        border-radius: 4px;
    }

    #productsGrid::-webkit-scrollbar-thumb:hover {
        background: var(--magenta-vibrant);
    }

    /* Smooth Transitions */
    .product-card-inner {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Range Slider Customization */
    .range-slider input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--bg-light-page);
        outline: none;
    }

    .range-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--magenta-vibrant);
        cursor: pointer;
        border: 2px solid var(--white-pure);
        box-shadow: 0 2px 8px rgba(216,27,96,0.3);
        transition: all 0.2s ease;
    }

    .range-slider input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        background: #B21550;
    }

    .range-slider input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--magenta-vibrant);
        cursor: pointer;
        border: 2px solid var(--white-pure);
        box-shadow: 0 2px 8px rgba(216,27,96,0.3);
    }

    .range-slider input[type="range"]::-moz-range-thumb:hover {
        background: #B21550;
    }

    /* Dropdown Items */
    .dropdown-item:hover {
        background-color: rgba(216,27,96,0.08);
        color: var(--magenta-vibrant);
    }

    .dropdown-item.active {
        background-color: var(--magenta-vibrant);
        color: white;
    }

    /* List Group Items */
    .list-group-item.active {
        background-color: var(--cyan-bright) !important;
        border-color: var(--cyan-bright) !important;
    }

    .list-group-item.active i {
        color: white !important;
    }

    .list-group-item-action:hover {
        background-color: rgba(0,172,193,0.08);
    }

    /* Badge Styles */
    .badge.bg-cyan {
        background-color: var(--cyan-bright) !important;
    }

    .badge.bg-magenta {
        background-color: var(--magenta-vibrant) !important;
    }

    .badge.bg-charcoal {
        background-color: var(--charcoal-dark) !important;
    }

    .badge.bg-grey-medium {
        background-color: var(--grey-medium) !important;
    }

    .badge.bg-soft-cyan {
        background-color: rgba(0,172,193,0.08) !important;
    }

    .badge.bg-soft-magenta {
        background-color: rgba(216,27,96,0.08) !important;
    }

    /* Button Outlines */
    .btn-outline-magenta {
        border: 2px solid var(--magenta-vibrant);
        color: var(--charcoal-dark);
        background: transparent;
        transition: all 0.3s ease;
    }

    .btn-outline-magenta:hover {
        background: var(--magenta-vibrant);
        color: white;
        transform: translateY(-2px);
    }

    .btn-outline-cyan {
        border: 2px solid var(--cyan-bright);
        color: var(--charcoal-dark);
        background: transparent;
        transition: all 0.3s ease;
    }

    .btn-outline-cyan:hover {
        background: var(--cyan-bright);
        color: white;
        transform: translateY(-2px);
    }

    .btn-outline-grey-medium {
        border: 2px solid var(--grey-medium);
        color: var(--charcoal-dark);
        background: transparent;
        transition: all 0.3s ease;
    }

    .btn-outline-grey-medium:hover {
        background: var(--grey-medium);
        color: white;
    }

    .btn-outline-grey-medium.active {
        background: var(--magenta-vibrant);
        color: white;
        border-color: var(--magenta-vibrant);
    }

    /* Text Colors */
    .text-magenta {
        color: var(--magenta-vibrant) !important;
    }

    .text-cyan {
        color: var(--cyan-bright) !important;
    }

    .text-link-blue {
        color: var(--link-blue) !important;
    }

    .text-charcoal {
        color: var(--charcoal-dark) !important;
    }

    .text-grey-medium {
        color: var(--grey-medium) !important;
    }

    /* Background Colors */
    .bg-magenta {
        background-color: var(--magenta-vibrant) !important;
    }

    .bg-cyan {
        background-color: var(--cyan-bright) !important;
    }

    .bg-charcoal {
        background-color: var(--charcoal-dark) !important;
    }

    .bg-grey-medium {
        background-color: var(--grey-medium) !important;
    }

    .bg-soft-magenta {
        background-color: rgba(216,27,96,0.08) !important;
    }

    .bg-soft-cyan {
        background-color: rgba(0,172,193,0.08) !important;
    }

    .bg-white {
        background-color: var(--white-pure) !important;
    }

    .bg-light-page {
        background-color: var(--bg-light-page) !important;
    }

    /* Border Colors */
    .border-magenta {
        border-color: var(--magenta-vibrant) !important;
    }

    .border-cyan {
        border-color: var(--cyan-bright) !important;
    }

    .border-grey-medium {
        border-color: var(--grey-medium) !important;
    }

    /* Opacity Utilities */
    .bg-opacity-85 {
        background-color: rgba(51,51,51,0.85) !important;
        backdrop-filter: blur(3px);
    }

    .opacity-90 {
        opacity: 0.9;
    }

    /* Animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.2);
        }
        100% {
            transform: scale(1);
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }

    .pulse {
        animation: pulse 0.5s ease-in-out;
    }

    /* Print Styles */
    @media print {
        .card {
            break-inside: avoid;
            box-shadow: none !important;
            border: 1px solid var(--grey-medium) !important;
        }
        
        .product-image-hover,
        .quick-view-btn,
        .wishlist-btn,
        .btn-group,
        .dropdown {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Filter form submission with loading state
    $('#filterForm').submit(function(e) {
        const button = $('#applyFilters');
        const originalText = button.html();
        button.prop('disabled', true).html('<span class="loading me-2"></span>Applying...');
        
        // Add slight delay for better UX
        setTimeout(() => {
            button.prop('disabled', false).html(originalText);
        }, 500);
    });

    // Sort functionality
    $('.dropdown-item[data-sort]').click(function(e) {
        e.preventDefault();
        const sortValue = $(this).data('sort');
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('sort', sortValue);
        window.location.href = currentUrl.toString();
    });

    // View toggle (Grid/List)
    $('[data-view]').click(function() {
        const view = $(this).data('view');
        $('[data-view]').removeClass('active');
        $(this).addClass('active');
        
        if (view === 'grid') {
            $('#productsGrid').removeClass('d-none');
            $('#productsList').addClass('d-none');
        } else {
            $('#productsGrid').addClass('d-none');
            $('#productsList').removeClass('d-none');
        }
    });

    // Price range validation and real-time update
    $('input[name="min_price"], input[name="max_price"]').on('input', function() {
        const minPrice = $('input[name="min_price"]').val();
        const maxPrice = $('input[name="max_price"]').val();
        
        if (minPrice && maxPrice && parseInt(minPrice) > parseInt(maxPrice)) {
            $(this).addClass('is-invalid');
            Mufra?.notify?.error('Minimum price cannot be greater than maximum price');
        } else {
            $(this).removeClass('is-invalid');
        }
        
        // Update range slider
        updatePriceRangeSlider();
    });
    
    function updatePriceRangeSlider() {
        const minPrice = parseInt($('input[name="min_price"]').val()) || 0;
        const maxPrice = parseInt($('input[name="max_price"]').val()) || 100000;
        $('#priceRange').val(maxPrice);
    }

    // Load more functionality
    let currentPage = 1;
    const itemsPerPage = 12;
    const allProducts = $('#productsGrid .product-card');
    
    if (allProducts.length > itemsPerPage) {
        // Hide products beyond first page
        allProducts.slice(itemsPerPage).hide();
    }
    
    $('#loadMore').click(function() {
        currentPage++;
        const nextProducts = allProducts.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
        
        if (nextProducts.length > 0) {
            nextProducts.fadeIn(500);
            
            // Hide button if no more products
            if (nextProducts.length < itemsPerPage) {
                $(this).hide();
            }
        } else {
            $(this).hide();
        }
    });

    // Add to cart with Mufra API
    $('.add-to-cart-form').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const button = form.find('button[type="submit"]');
        const productId = form.data('product-id');
        
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        
        const quantity = form.find('input[name="quantity"]').val() || 1;
        const size = form.find('input[name="size"]').val() || '';
        const color = form.find('input[name="color"]').val() || '';
        
        if (window.Mufra && window.Mufra.cart) {
            window.Mufra.cart.add(productId, quantity, size, color)
                .finally(() => {
                    button.prop('disabled', false).html('<i class="fas fa-cart-plus"></i>');
                });
        } else {
            // Fallback
            $.ajax({
                type: 'POST',
                url: `/add-to-cart/${productId}`,
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        showToast('Success', response.message, 'success');
                        $('.cart-count-badge').text(response.cart_count || 0);
                        animateCartIcon();
                    } else {
                        showToast('Error', response.message, 'danger');
                    }
                },
                error: function() {
                    showToast('Error', 'Network error. Please try again.', 'danger');
                },
                complete: function() {
                    button.prop('disabled', false).html('<i class="fas fa-cart-plus"></i>');
                }
            });
        }
    });

    // Wishlist functionality with Mufra API
    $('.wishlist-btn').click(function(e) {
        e.preventDefault();
        const button = $(this);
        const productId = button.data('product-id');
        
        if (!productId) {
            Mufra?.notify?.error('Product not available');
            return;
        }
        
        if (window.Mufra && window.Mufra.wishlist) {
            window.Mufra.wishlist.toggle(productId)
                .then((response) => {
                    if (response.in_wishlist) {
                        button.addClass('active');
                        button.find('i').removeClass('far').addClass('fas');
                    } else {
                        button.removeClass('active');
                        button.find('i').removeClass('fas').addClass('far');
                    }
                });
        } else {
            // Fallback
            $.ajax({
                type: 'POST',
                url: '/toggle-wishlist/' + productId,
                success: function(response) {
                    if (response.success) {
                        if (response.in_wishlist) {
                            button.addClass('active');
                            button.find('i').removeClass('far').addClass('fas');
                            showToast('Success', 'Added to wishlist!', 'success');
                        } else {
                            button.removeClass('active');
                            button.find('i').removeClass('fas').addClass('far');
                            showToast('Info', 'Removed from wishlist', 'info');
                        }
                    } else {
                        if (response.requires_login) {
                            window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                        } else {
                            showToast('Error', response.message, 'danger');
                        }
                    }
                },
                error: function() {
                    showToast('Error', 'Network error. Please try again.', 'danger');
                }
            });
        }
    });

    // Quick view functionality
    $('.quick-view-btn').click(function(e) {
        e.preventDefault();
        const productId = $(this).data('product-id');
        
        if (!productId) {
            Mufra?.notify?.error('Product not available');
            return;
        }
        
        // Redirect to product details page
        window.location.href = '/product/' + productId;
    });

    // Fallback toast notification function
    function showToast(title, message, type) {
        if (window.Mufra && window.Mufra.notify) {
            if (type === 'success') Mufra.notify.success(message);
            else if (type === 'danger') Mufra.notify.error(message);
            else Mufra.notify.info(message);
            return;
        }
        
        // Remove existing toasts
        $('.toast-container').remove();
        
        const bgColor = type === 'success' ? 'var(--magenta-vibrant)' : 
                       type === 'danger' ? 'var(--cyan-bright)' : 'var(--link-blue)';
        
        const toastHtml = `
            <div class="toast-container">
                <div class="toast show" role="alert" style="border-left: 6px solid ${bgColor};">
                    <div class="toast-header bg-${type} text-white">
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            </div>
        `;
        
        $('body').append(toastHtml);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            $('.toast-container').fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }
    
    // Cart icon animation
    function animateCartIcon() {
        const cartIcon = $('.cart-count-badge');
        cartIcon.addClass('pulse');
        setTimeout(() => {
            cartIcon.removeClass('pulse');
        }, 1000);
    }

    // Initialize range slider
    updatePriceRangeSlider();
    
    // Update price inputs when slider changes
    $('#priceRange').on('input', function() {
        $('input[name="max_price"]').val($(this).val());
    });

    // Product image lazy loading
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.getAttribute('data-src');
                    if (src) {
                        img.src = src;
                        img.removeAttribute('data-src');
                    }
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.1
        });
        
        // Observe all product images
        document.querySelectorAll('.product-image[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }

    // Keyboard shortcuts
    $(document).keydown(function(e) {
        // Alt + F to focus search/filter
        if (e.altKey && e.key === 'f') {
            e.preventDefault();
            $('input[name="min_price"]').focus();
        }
        // Escape to clear filters
        if (e.key === 'Escape') {
            if (window.location.search) {
                window.location.href = window.location.pathname;
            }
        }
    });

    // Update product counts in real-time based on filters
    function updateProductCounts() {
        const visibleProducts = $('#productsGrid .product-card:visible').length;
        const totalProducts = {{ products|length }};
        $('.product-count').text(`${visibleProducts} of ${totalProducts} products`);
    }

    // Call update on load and when products change
    updateProductCounts();
    
    // Debounce function for performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Debounced filter application for better performance
    const debouncedFilter = debounce(function() {
        $('#filterForm').submit();
    }, 500);
    
    // Apply debounced filter on some inputs
    $('input[type="radio"], input[type="checkbox"]').change(debouncedFilter);
});
</script>
{% endblock %}