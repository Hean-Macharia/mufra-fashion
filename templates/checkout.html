{% extends "base.html" %}

{% block title %}Checkout - MUFRA FASHIONS{% endblock %}

{% block content %}
<div class="container">
    <div class="checkout-header">
        <h1 class="page-title">Checkout</h1>
        <div class="checkout-steps">
            <div class="step active">
                <span class="step-number">1</span>
                <span class="step-label">Cart</span>
            </div>
            <div class="step active">
                <span class="step-number">2</span>
                <span class="step-label">Information</span>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <span class="step-label">Payment</span>
            </div>
            <div class="step">
                <span class="step-number">4</span>
                <span class="step-label">Confirmation</span>
            </div>
        </div>
    </div>
    
    {% if error %}
    <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i>
        {{ error }}
    </div>
    {% endif %}
    
    <div class="checkout-container">
        <!-- Left Column: Order Form -->
        <div class="checkout-form-section">
            <form method="POST" action="{{ url_for('checkout') }}" class="checkout-form">
                <!-- Shipping Information -->
                <section class="form-section">
                    <h2 class="form-title">
                        <i class="fas fa-shipping-fast"></i> Shipping Information
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Full Name *</label>
                            <input type="text" id="name" name="name" required 
                                   placeholder="Enter your full name">
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" required 
                                   placeholder="e.g. 0712 345 678">
                            <small class="help-text">For delivery updates</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Delivery Address *</label>
                        <textarea id="address" name="address" required 
                                  rows="3" 
                                  placeholder="House number, street, estate"></textarea>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="city">City/Town *</label>
                            <input type="text" id="city" name="city" required 
                                   placeholder="e.g. Embu">
                        </div>
                        
                        <div class="form-group">
                            <label for="region">Region/County *</label>
                            <select id="region" name="region" required onchange="updateDeliveryFee()">
                                <option value="">Select region</option>
                                <option value="embu">Embu County (Free Shipping)</option>
                                <option value="meru">Meru County (KSh 150)</option>
                                <option value="kirinyaga">Kirinyaga County (KSh 150)</option>
                                <option value="tharakanithi">Tharaka Nithi (KSh 150)</option>
                                <option value="nairobi">Nairobi (KSh 200)</option>
                                <option value="other">Other Regions (KSh 250)</option>
                            </select>
                        </div>
                    </div>
                </section>
                
                <!-- Payment Method -->
                <section class="form-section">
                    <h2 class="form-title">
                        <i class="fas fa-credit-card"></i> Payment Method
                    </h2>
                    
                    <div class="payment-methods">
                        <div class="payment-option">
                            <input type="radio" id="mpesa" name="payment_method" value="mpesa" checked>
                            <label for="mpesa" class="payment-label">
                                <div class="payment-icon">
                                    <i class="fab fa-cc-m-pesa"></i>
                                </div>
                                <div class="payment-info">
                                    <h4>M-Pesa</h4>
                                    <p>Pay with M-Pesa via STK Push</p>
                                </div>
                            </label>
                        </div>
                        
                        <div class="payment-option">
                            <input type="radio" id="airtel" name="payment_method" value="airtel">
                            <label for="airtel" class="payment-label">
                                <div class="payment-icon">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div class="payment-info">
                                    <h4>Airtel Money</h4>
                                    <p>Pay with Airtel Money</p>
                                </div>
                            </label>
                        </div>
                        
                        <div class="payment-option">
                            <input type="radio" id="cod" name="payment_method" value="cod">
                            <label for="cod" class="payment-label">
                                <div class="payment-icon">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="payment-info">
                                    <h4>Cash on Delivery</h4>
                                    <p>Pay when you receive your order</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Payment Details (conditional) -->
                    <div class="payment-details" id="mpesaDetails">
                        <div class="form-group">
                            <label for="payment_number">M-Pesa Number *</label>
                            <input type="tel" id="payment_number" name="payment_number" 
                                   placeholder="e.g. 0712 345 678" 
                                   value="{{ request.form.payment_number or '' }}">
                            <small class="help-text">We'll send an STK Push to this number</small>
                        </div>
                    </div>
                    
                    <div class="payment-details" id="airtelDetails" style="display: none;">
                        <div class="form-group">
                            <label for="airtel_number">Airtel Money Number *</label>
                            <input type="tel" id="airtel_number" name="payment_number" 
                                   placeholder="e.g. 0733 123 456" 
                                   value="{{ request.form.payment_number or '' }}">
                            <small class="help-text">We'll send a payment request to this number</small>
                        </div>
                    </div>
                </section>
                
                <!-- Terms and Conditions -->
                <section class="form-section">
                    <div class="form-group terms">
                        <label class="checkbox-label">
                            <input type="checkbox" name="terms" required>
                            <span>I agree to the <a href="#terms">Terms and Conditions</a> and <a href="#privacy">Privacy Policy</a> *</span>
                        </label>
                    </div>
                    
                    <div class="form-group terms">
                        <label class="checkbox-label">
                            <input type="checkbox" name="newsletter">
                            <span>Sign up for our newsletter for updates and exclusive offers</span>
                        </label>
                    </div>
                </section>
                
                <!-- Order Actions -->
                <div class="order-actions">
                    <a href="{{ url_for('cart') }}" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> Back to Cart
                    </a>
                    <button type="submit" class="btn btn-primary">
                        Complete Order <i class="fas fa-lock"></i>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Right Column: Order Summary -->
        <div class="order-summary-section">
            <div class="order-summary">
                <h2 class="summary-title">Order Summary</h2>
                
                <!-- Order Items -->
                <div class="order-items">
                    {% for item in session.cart %}
                    <div class="order-item">
                        <div class="item-image">
                            <img src="https://via.placeholder.com/60x60?text=Product" alt="Product">
                        </div>
                        <div class="item-details">
                            <h4>Product {{ loop.index }}</h4>
                            {% if item.size or item.color %}
                            <p class="item-variants">
                                {% if item.size %}{{ item.size }}{% endif %}
                                {% if item.color %} • {{ item.color }}{% endif %}
                            </p>
                            {% endif %}
                        </div>
                        <div class="item-quantity">× {{ item.quantity }}</div>
                        <div class="item-price">KSh 29.99</div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Price Breakdown -->
                <div class="price-breakdown">
                    <div class="price-row">
                        <span>Subtotal</span>
                        <span>KSh <span id="subtotal">0.00</span></span>
                    </div>
                    <div class="price-row">
                        <span>Delivery Fee</span>
                        <span>KSh <span id="deliveryFee">0.00</span></span>
                    </div>
                    <div class="price-row discount">
                        <span>Discount</span>
                        <span>- KSh 0.00</span>
                    </div>
                    
                    <div class="price-divider"></div>
                    
                    <div class="price-row total">
                        <span>Total</span>
                        <span>KSh <span id="totalAmount">0.00</span></span>
                    </div>
                </div>
                
                <!-- Delivery Estimate -->
                <div class="delivery-estimate">
                    <h3><i class="fas fa-truck"></i> Delivery Estimate</h3>
                    <div class="estimate-info">
                        <div class="estimate-item">
                            <span class="estimate-label">Standard Delivery:</span>
                            <span class="estimate-value">3-5 business days</span>
                        </div>
                        <div class="estimate-item">
                            <span class="estimate-label">Express Delivery:</span>
                            <span class="estimate-value">1-2 business days</span>
                        </div>
                    </div>
                </div>
                
                <!-- Support Info -->
                <div class="support-info">
                    <h3><i class="fas fa-headset"></i> Need Help?</h3>
                    <p>Call us at <strong>+254 712 345 678</strong> or email <strong>support@mufrafashions.com</strong></p>
                </div>
            </div>
            
            <!-- Security Badges -->
            <div class="security-badges">
                <div class="security-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure Payment</span>
                </div>
                <div class="security-badge">
                    <i class="fas fa-lock"></i>
                    <span>SSL Encrypted</span>
                </div>
                <div class="security-badge">
                    <i class="fas fa-user-shield"></i>
                    <span>Privacy Protected</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Checkout Styles */
.checkout-header {
    text-align: center;
    margin: 40px 0;
}

.page-title {
    font-size: 2.5rem;
    color: #333;
    margin-bottom: 30px;
}

.checkout-steps {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin: 40px auto;
    max-width: 800px;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
    flex: 1;
}

.step::before {
    content: '';
    position: absolute;
    top: 20px;
    left: -50%;
    width: 100%;
    height: 2px;
    background: #ddd;
    z-index: 1;
}

.step:first-child::before {
    display: none;
}

.step.active::before {
    background: #667eea;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #ddd;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    position: relative;
    z-index: 2;
}

.step.active .step-number {
    background: #667eea;
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.step-label {
    font-size: 0.9rem;
    color: #999;
    font-weight: 500;
}

.step.active .step-label {
    color: #667eea;
    font-weight: 600;
}

/* Alert */
.alert {
    padding: 15px 20px;
    border-radius: 10px;
    margin: 20px 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert i {
    font-size: 1.2rem;
}

/* Checkout Container */
.checkout-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 40px;
    margin-bottom: 60px;
}

@media (max-width: 992px) {
    .checkout-container {
        grid-template-columns: 1fr;
    }
    
    .checkout-steps {
        flex-direction: column;
        gap: 20px;
    }
    
    .step::before {
        display: none;
    }
}

/* Form Sections */
.form-section {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.form-title {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-title i {
    color: #667eea;
}

/* Form Grid */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}

/* Form Groups */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s;
    background: white;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.help-text {
    display: block;
    margin-top: 5px;
    font-size: 0.85rem;
    color: #666;
}

/* Payment Methods */
.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.payment-option {
    position: relative;
}

.payment-option input {
    display: none;
}

.payment-label {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.payment-option input:checked + .payment-label {
    border-color: #667eea;
    background: #f0f4ff;
}

.payment-icon {
    font-size: 2rem;
    color: #667eea;
}

.payment-info h4 {
    margin: 0 0 5px 0;
    color: #333;
}

.payment-info p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

/* Payment Details */
.payment-details {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

/* Terms and Conditions */
.terms {
    margin-bottom: 15px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    color: #333;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-label a {
    color: #667eea;
    text-decoration: none;
}

.checkbox-label a:hover {
    text-decoration: underline;
}

/* Order Actions */
.order-actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    padding-top: 30px;
    border-top: 1px solid #eee;
}

.order-actions .btn {
    flex: 1;
    padding: 15px;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 600;
}

/* Order Summary */
.order-summary {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.summary-title {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #667eea;
}

/* Order Items */
.order-items {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 25px;
    padding-right: 10px;
}

.order-items::-webkit-scrollbar {
    width: 6px;
}

.order-items::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.order-items::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

.order-items::-webkit-scrollbar-thumb:hover {
    background: #999;
}

.order-item {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 15px;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 10px;
}

.item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-details h4 {
    margin: 0 0 5px 0;
    font-size: 0.95rem;
    color: #333;
}

.item-variants {
    margin: 0;
    font-size: 0.85rem;
    color: #666;
}

.item-quantity {
    font-weight: 600;
    color: #333;
}

.item-price {
    font-weight: 600;
    color: #667eea;
}

/* Price Breakdown */
.price-breakdown {
    margin: 25px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    color: #666;
}

.price-row.total {
    font-size: 1.5rem;
    font-weight: 700;
    color: #333;
    margin-top: 10px;
}

.price-divider {
    height: 1px;
    background: #ddd;
    margin: 15px 0;
}

/* Delivery Estimate */
.delivery-estimate {
    padding: 20px;
    background: #f0f4ff;
    border-radius: 10px;
    margin-bottom: 20px;
}

.delivery-estimate h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: #333;
}

.delivery-estimate h3 i {
    color: #667eea;
}

.estimate-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.estimate-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
}

.estimate-label {
    color: #666;
}

.estimate-value {
    font-weight: 600;
    color: #333;
}

/* Support Info */
.support-info {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    text-align: center;
}

.support-info h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    margin-bottom: 10px;
    color: #333;
}

.support-info h3 i {
    color: #667eea;
}

.support-info p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

/* Security Badges */
.security-badges {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.security-badge {
    background: white;
    border-radius: 10px;
    padding: 15px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s;
}

.security-badge:hover {
    transform: translateY(-3px);
}

.security-badge i {
    font-size: 1.5rem;
    color: #667eea;
}

.security-badge span {
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
}

@media (max-width: 576px) {
    .security-badges {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate totals
    updateTotals();
    
    // Update delivery fee when region changes
    const regionSelect = document.getElementById('region');
    if (regionSelect) {
        regionSelect.addEventListener('change', updateDeliveryFee);
    }
    
    // Show/hide payment details based on selection
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    paymentMethods.forEach(method => {
        method.addEventListener('change', togglePaymentDetails);
    });
    
    // Initialize payment details
    togglePaymentDetails();
});

function updateTotals() {
    // In a real application, calculate from cart items
    // For demo, use fixed values
    const subtotal = 59.98; // Example total
    const deliveryFee = parseInt(document.getElementById('deliveryFee').textContent) || 0;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('totalAmount').textContent = (subtotal + deliveryFee).toFixed(2);
}

function updateDeliveryFee() {
    const region = document.getElementById('region').value;
    let deliveryFee = 0;
    
    if (region === 'embu') {
        deliveryFee = 0;
    } else if (['meru', 'kirinyaga', 'tharakanithi'].includes(region)) {
        deliveryFee = 150;
    } else if (region === 'nairobi') {
        deliveryFee = 200;
    } else if (region === 'other') {
        deliveryFee = 250;
    }
    
    document.getElementById('deliveryFee').textContent = deliveryFee.toFixed(2);
    updateTotals();
}

function togglePaymentDetails() {
    const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
    
    // Hide all payment details
    document.querySelectorAll('.payment-details').forEach(el => {
        el.style.display = 'none';
    });
    
    // Show selected payment details
    if (selectedMethod === 'mpesa') {
        document.getElementById('mpesaDetails').style.display = 'block';
        document.getElementById('payment_number').required = true;
    } else if (selectedMethod === 'airtel') {
        document.getElementById('airtelDetails').style.display = 'block';
        document.getElementById('airtel_number').required = true;
    } else {
        document.getElementById('payment_number').required = false;
    }
}

// Form validation
const checkoutForm = document.querySelector('.checkout-form');
if (checkoutForm) {
    checkoutForm.addEventListener('submit', function(e) {
        const region = document.getElementById('region').value;
        if (!region) {
            e.preventDefault();
            alert('Please select your region');
            return false;
        }
        
        const terms = document.querySelector('input[name="terms"]');
        if (!terms.checked) {
            e.preventDefault();
            alert('Please agree to the Terms and Conditions');
            return false;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        }
        
        return true;
    });
}

// Format phone number
function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.startsWith('254')) {
        value = value.substr(3);
    } else if (value.startsWith('0')) {
        value = value.substr(1);
    }
    
    if (value.length > 0) {
        value = '0' + value;
    }
    
    if (value.length > 3) {
        value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1 $2 $3');
    }
    
    input.value = value;
}

// Add phone number formatting
const phoneInputs = document.querySelectorAll('input[type="tel"]');
phoneInputs.forEach(input => {
    input.addEventListener('input', function() {
        formatPhoneNumber(this);
    });
});
</script>
{% endblock %}