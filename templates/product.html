{% extends "base.html" %}

{% block title %}{{ product.name }} - MUFRA FASHIONS{% endblock %}

{% block content %}
<div class="container">
    <div class="breadcrumb">
        <a href="{{ url_for('home') }}">Home</a>
        <i class="fas fa-chevron-right"></i>
        <a href="{{ url_for('categories') }}?category={{ product.category }}">{{ product.category|title }}</a>
        <i class="fas fa-chevron-right"></i>
        <a href="{{ url_for('categories') }}?subcategory={{ product.subcategory }}">{{ product.subcategory|title }}</a>
        <i class="fas fa-chevron-right"></i>
        <span>{{ product.name|truncate(30) }}</span>
    </div>
    
    <div class="product-detail">
        <!-- Product Gallery -->
        <div class="product-gallery">
            <div class="main-image">
                {% if product.images and product.images[0] %}
                    <img src="{{ product.images[0] }}" 
                         alt="{{ product.name }}"
                         id="mainProductImage"
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/600x600?text=No+Image';">
                {% else %}
                    <img src="https://via.placeholder.com/600x600?text=No+Image" 
                         alt="{{ product.name }}"
                         id="mainProductImage">
                {% endif %}
            </div>
            
            {% if product.images and product.images|length > 1 %}
            <div class="thumbnail-gallery">
                {% for image in product.images %}
                <div class="thumbnail {% if loop.first %}active{% endif %}" 
                     onclick="changeMainImage(this, '{{ image }}')">
                    <img src="{{ image }}" 
                         alt="{{ product.name }} - Image {{ loop.index }}"
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/100x100?text=No+Image';">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div class="product-info">
            <h1 class="product-title">{{ product.name }}</h1>
            
            <div class="product-meta">
                <div class="product-price">
                    <span class="current-price">KSh {{ "%.2f"|format(product.price) }}</span>
                    {% if product.original_price %}
                    <span class="original-price">KSh {{ "%.2f"|format(product.original_price) }}</span>
                    <span class="discount-badge">-{{ ((1 - product.price/product.original_price) * 100)|int }}%</span>
                    {% endif %}
                </div>
                
                <div class="product-rating">
                    <div class="stars">
                        {% for i in range(5) %}
                            <i class="fas fa-star {% if i < 4 %}filled{% endif %}"></i>
                        {% endfor %}
                    </div>
                    <span class="rating-text">(4.2 â€¢ 24 reviews)</span>
                </div>
                
                <div class="stock-status">
                    {% if product.stock > 10 %}
                        <span class="in-stock"><i class="fas fa-check-circle"></i> In Stock</span>
                    {% elif product.stock > 0 %}
                        <span class="low-stock"><i class="fas fa-exclamation-circle"></i> Only {{ product.stock }} left!</span>
                    {% else %}
                        <span class="out-of-stock"><i class="fas fa-times-circle"></i> Out of Stock</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="product-description">
                <h3>Description</h3>
                <p>{{ product.description }}</p>
            </div>
            
            <!-- Product Variants -->
            <div class="product-variants">
                {% if product.sizes and product.sizes|length > 0 %}
                <div class="variant-selector">
                    <label for="size">Size:</label>
                    <div class="size-options">
                        {% for size in product.sizes %}
                        <label class="size-option">
                            <input type="radio" name="size" value="{{ size }}" 
                                   {% if loop.first %}checked{% endif %}>
                            <span class="size-label">{{ size }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if product.colors and product.colors|length > 0 %}
                <div class="variant-selector">
                    <label for="color">Color:</label>
                    <div class="color-options">
                        {% for color in product.colors %}
                        <label class="color-option" style="background-color: {{ color|lower }};">
                            <input type="radio" name="color" value="{{ color }}" 
                                   {% if loop.first %}checked{% endif %}>
                            <span class="color-checkmark"><i class="fas fa-check"></i></span>
                            <span class="color-label">{{ color }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Quantity and Add to Cart -->
            <div class="product-actions">
                <div class="quantity-selector">
                    <label for="quantity">Quantity:</label>
                    <div class="quantity-control">
                        <button class="quantity-btn minus" onclick="decreaseQuantity()">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="quantity" value="1" min="1" max="{{ product.stock }}">
                        <button class="quantity-btn plus" onclick="increaseQuantity()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary btn-cart" onclick="addToCart()">
                        <i class="fas fa-cart-plus"></i> Add to Cart
                    </button>
                    <button class="btn btn-outline btn-wishlist" onclick="addToWishlist()">
                        <i class="fas fa-heart"></i> Add to Wishlist
                    </button>
                </div>
            </div>
            
            <!-- Product Details -->
            <div class="product-details">
                <div class="details-grid">
                    <div class="detail-item">
                        <i class="fas fa-truck"></i>
                        <div>
                            <strong>Free Shipping</strong>
                            <p>Free delivery within Embu</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-undo"></i>
                        <div>
                            <strong>30-Day Returns</strong>
                            <p>Easy return policy</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <strong>Secure Payment</strong>
                            <p>100% secure payment</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Related Products -->
    <section class="related-products">
        <h2 class="section-title">You May Also Like</h2>
        <div class="products-grid">
            <!-- Related products would be loaded here -->
            <div class="product-card">
                <div class="product-image">
                    <img src="https://via.placeholder.com/300x300" alt="Related Product">
                </div>
                <div class="product-info">
                    <h3>Related Product</h3>
                    <p class="price">KSh 45.99</p>
                    <button class="btn btn-secondary">View Details</button>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
/* Breadcrumb */
.breadcrumb {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 20px 0 40px;
    font-size: 0.9rem;
    color: #666;
}

.breadcrumb a {
    color: #667eea;
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.breadcrumb i {
    font-size: 0.8rem;
    color: #999;
}

/* Product Detail Layout */
.product-detail {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 50px;
    margin-bottom: 60px;
}

@media (max-width: 992px) {
    .product-detail {
        grid-template-columns: 1fr;
    }
}

/* Product Gallery */
.product-gallery {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.main-image {
    width: 100%;
    height: 500px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.main-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.thumbnail-gallery {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.thumbnail.active {
    border-color: #667eea;
}

.thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.thumbnail:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Product Info */
.product-title {
    font-size: 2.5rem;
    margin-bottom: 20px;
    color: #333;
    line-height: 1.3;
}

.product-meta {
    margin-bottom: 30px;
}

.product-price {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.current-price {
    font-size: 2.2rem;
    font-weight: 700;
    color: #667eea;
}

.original-price {
    font-size: 1.5rem;
    color: #999;
    text-decoration: line-through;
}

.discount-badge {
    background: #ff4444;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.product-rating {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.stars {
    color: #ddd;
    font-size: 1.2rem;
}

.stars .filled {
    color: #ffc107;
}

.rating-text {
    color: #666;
    font-size: 0.9rem;
}

.stock-status {
    margin-bottom: 15px;
}

.stock-status span {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.in-stock {
    background: #d4edda;
    color: #155724;
}

.low-stock {
    background: #fff3cd;
    color: #856404;
}

.out-of-stock {
    background: #f8d7da;
    color: #721c24;
}

.product-description h3 {
    font-size: 1.3rem;
    margin-bottom: 15px;
    color: #333;
}

.product-description p {
    color: #666;
    line-height: 1.6;
    margin-bottom: 30px;
}

/* Product Variants */
.product-variants {
    margin-bottom: 30px;
}

.variant-selector {
    margin-bottom: 20px;
}

.variant-selector label {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
}

.size-options, .color-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.size-option {
    position: relative;
}

.size-option input {
    display: none;
}

.size-label {
    display: inline-block;
    padding: 8px 20px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 40px;
    text-align: center;
}

.size-option input:checked + .size-label {
    border-color: #667eea;
    background: #667eea;
    color: white;
}

.size-option:hover .size-label {
    border-color: #667eea;
}

.color-option {
    position: relative;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
}

.color-option input {
    display: none;
}

.color-checkmark {
    display: none;
    color: white;
    font-size: 0.8rem;
}

.color-option input:checked + .color-checkmark {
    display: block;
}

.color-label {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.8rem;
    white-space: nowrap;
    margin-top: 5px;
    color: #666;
}

/* Product Actions */
.product-actions {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
}

.quantity-selector {
    margin-bottom: 20px;
}

.quantity-selector label {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
}

.quantity-control {
    display: flex;
    align-items: center;
    gap: 15px;
}

.quantity-btn {
    width: 45px;
    height: 45px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.3s;
}

.quantity-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

#quantity {
    width: 80px;
    text-align: center;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
}

.action-buttons {
    display: flex;
    gap: 15px;
}

.btn-cart, .btn-wishlist {
    flex: 1;
    padding: 15px;
    font-size: 1.1rem;
}

.btn-cart {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-cart:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

/* Product Details */
.product-details {
    margin-top: 30px;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.detail-item i {
    font-size: 1.5rem;
    color: #667eea;
}

.detail-item strong {
    display: block;
    margin-bottom: 5px;
    color: #333;
}

.detail-item p {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
}

/* Related Products */
.related-products {
    margin-top: 60px;
    padding-top: 40px;
    border-top: 1px solid #eee;
}

.section-title {
    font-size: 2rem;
    margin-bottom: 40px;
    text-align: center;
    color: #333;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 30px;
}

.product-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s;
}

.product-card:hover {
    transform: translateY(-10px);
}

.product-card .product-image {
    height: 200px;
    overflow: hidden;
}

.product-card .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s;
}

.product-card:hover .product-image img {
    transform: scale(1.05);
}

.product-card .product-info {
    padding: 20px;
}

.product-card .product-info h3 {
    font-size: 1.1rem;
    margin-bottom: 10px;
    color: #333;
}

.product-card .price {
    color: #667eea;
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .details-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .product-title {
        font-size: 1.8rem;
    }
    
    .current-price {
        font-size: 1.8rem;
    }
}
</style>

<script>
function changeMainImage(thumbnail, imageUrl) {
    // Update main image
    const mainImage = document.getElementById('mainProductImage');
    mainImage.src = imageUrl;
    
    // Update active thumbnail
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    thumbnail.classList.add('active');
}

function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    const max = parseInt(quantityInput.max) || 10;
    let value = parseInt(quantityInput.value);
    if (value < max) {
        quantityInput.value = value + 1;
    }
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    let value = parseInt(quantityInput.value);
    if (value > 1) {
        quantityInput.value = value - 1;
    }
}

function addToCart() {
    const productId = '{{ product._id }}';
    const quantity = document.getElementById('quantity').value;
    const size = document.querySelector('input[name="size"]:checked')?.value || '';
    const color = document.querySelector('input[name="color"]:checked')?.value || '';
    
    fetch('/add_to_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'product_id': productId,
            'quantity': quantity,
            'size': size,
            'color': color
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Product added to cart!', 'success');
            // Update cart count
            document.dispatchEvent(new Event('cartUpdated'));
        } else {
            showToast('Error adding to cart', 'error');
        }
    })
    .catch(error => {
        showToast('Error adding to cart', 'error');
        console.error('Error:', error);
    });
}

function addToWishlist() {
    showToast('Added to wishlist!', 'success');
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                          type === 'error' ? 'fa-exclamation-circle' : 
                          'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#d4edda' : 
                     type === 'error' ? '#f8d7da' : 
                     '#d1ecf1'};
        color: ${type === 'success' ? '#155724' : 
                type === 'error' ? '#721c24' : 
                '#0c5460'};
        padding: 1rem 1.5rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        animation: slideInRight 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}